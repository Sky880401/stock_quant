# 📋 訓練結果診斷指南 | Training Result Diagnostic Guide

**版本**: V12.0 | **建立日期**: 2026-02-01 | **語言**: Traditional Chinese (繁體中文)

---

## 目錄 (Table of Contents)

1. [概述](#概述)
2. [診斷矩陣](#診斷矩陣)
3. [異常結果類型](#異常結果類型)
4. [根本原因分析](#根本原因分析)
5. [案例研究](#案例研究)
6. [最佳實踐](#最佳實踐)

---

## 概述

訓練結果診斷系統用於幫助管理員和用戶判斷策略訓練結果的品質。本指南提供結構化的診斷流程，以識別異常結果並提供具體的改善建議。

### 核心診斷指標

| 指標 | 正常範圍 | 警告範圍 | 異常範圍 |
|------|---------|---------|---------|
| **ROI** | -50% 到 +100% | -50% 到 0% | < -50% 或 -999% |
| **勝率** | 30% 到 80% | 20% 到 30% | < 20% 或 0% |
| **Sharpe比率** | 0.5 到 3.0 | 0.2 到 0.5 | < 0.2 或 0% |
| **交易次數** | > 20 筆 | 5 到 20 筆 | < 5 筆 |
| **最大回撤** | < 50% | 50% 到 100% | > 100% |
| **成功率** | > 80% | 50% 到 80% | < 50% |

---

## 診斷矩陣

### 診斷流程圖

```
開始訓練
    ↓
結果返回 (ROI, 勝率, Sharpe, 交易數)
    ↓
├─ ROI = -999% ?
│  ├─ YES → 數據不足或參數衝突
│  │         └─ 交易數 = 0 ? → 數據不足 (< 100 K線)
│  │         └─ 交易數 > 0 ? → 參數邏輯錯誤
│  └─ NO → 繼續檢查
│
├─ 勝率 = 0% ?
│  ├─ YES & 交易數 = 0 → 無交易信號
│  ├─ YES & 交易數 > 0 → 策略效能問題
│  └─ NO → 繼續檢查
│
├─ Sharpe = 0% ?
│  └─ YES → 風險調整效能缺失
│
└─ 成功率 < 50% ?
   └─ YES → 參數組合過度優化或不適合
```

### 診斷決策樹

```python
def diagnose_result(roi, win_rate, sharpe, trades, success_rate):
    
    if roi == -999.0:
        if trades == 0:
            return "🔴 嚴重異常: 數據不足"
            # 原因: 時間段太短 (< 100 K線)
            # 解決: 選擇更長時間段
        else:
            return "🔴 嚴重異常: 參數衝突"
            # 原因: 參數邏輯錯誤 (e.g., fast > slow)
            # 解決: 檢查參數範圍
    
    if win_rate == 0.0 and trades == 0:
        return "🔴 嚴重異常: 無交易信號"
        # 原因: 策略條件過於嚴格
        # 解決: 調整進場條件敏感度
    
    if success_rate < 50:
        return "🟡 需要改進: 參數組合低成功率"
        # 原因: 參數範圍設置過激進
        # 解決: 縮小參數搜索範圍
    
    if roi < 0 and roi > -50:
        return "🟡 需要改進: 負收益"
        # 原因: 市場環境或策略選擇
        # 解決: 嘗試不同時間段或策略
    
    if 30 > win_rate > 0:
        return "🟡 需要改進: 勝率低"
        # 原因: 進場/出場條件不優化
        # 解決: 調整信號閾值
    
    return "✅ 正常: 結果符合預期"
```

---

## 異常結果類型

### 類型 1: ROI = -999% (最常見)

**症狀**:
- ROI: -999.00%
- 勝率: 0.0%
- Sharpe: 0.0
- 交易數: 0

**根本原因** (優先順序):
1. **80% 概率**: 數據不足 (< 100 K線)
   - 時間段過短 (如 1 個月)
   - 股票在該期間無法產生足夠 K 線
   - 例: 2025-11-01 至 2025-11-30 只有 ~20 個交易日

2. **15% 概率**: 參數邏輯錯誤
   - 快速期間 ≥ 慢速期間 (MA交叉)
   - 上界 ≤ 下界 (布林帶)
   - 參數範圍過於極端

3. **5% 概率**: 策略代碼錯誤
   - 信號生成邏輯缺陷
   - 進場/出場條件同時觸發

**解決方案**:

| 優先級 | 行動 | 預期結果 |
|-------|------|---------|
| 1 | 選擇更長時間段 (≥ 6 個月) | 獲取足夠 K 線 (> 100 根) |
| 2 | 驗證參數邏輯 | 確保 fast < slow 等條件 |
| 3 | 檢查策略代碼 | 確認信號生成正常 |
| 4 | 嘗試不同策略 | 驗證是否策略本身問題 |

**測試案例**:

```
案例 A (正常): 
  ✅ 時間段: 2025-08-01 至 2026-01-31 (6 個月)
  ✅ K 線數: ~120 根
  ✅ ROI: 0.35%, 勝率: 45%, Sharpe: 0.82
  ✅ 結論: 數據充分，結果可信

案例 B (異常):
  ❌ 時間段: 2025-11-01 至 2025-11-30 (1 個月)
  ❌ K 線數: ~20 根
  ❌ ROI: -999%, 勝率: 0%, Sharpe: 0.0
  ❌ 結論: 數據不足，建議更長時間段
```

### 類型 2: 高 ROI 但低勝率

**症狀**:
- ROI: 50% - 150%
- 勝率: < 30%
- 交易數: 5 - 15 筆

**根本原因**:
- 幸運交易造成的過度優化
- 樣本容量太小 (交易 < 30 筆)
- 策略可能對歷史數據過度擬合

**解決方案**:
1. 在更長時間段測試 (確保 > 50 筆交易)
2. 在不同股票上驗證
3. 考慮使用交叉驗證

### 類型 3: 低 Sharpe 比率但正 ROI

**症狀**:
- ROI: 10% - 30% (正常)
- 勝率: 40% - 60% (正常)
- Sharpe: 0.1 - 0.5 (低)

**根本原因**:
- 回撤過大 (風險波動高)
- 收益率不穩定
- 缺乏適當的風險管理

**解決方案**:
1. 減少單筆交易風險
2. 增加止損機制
3. 考慮使用動態頭寸管理

### 類型 4: 低成功率 (< 50%)

**症狀**:
- 成功組合: 2/16 (12.5%)
- 平均結果不穩定
- 難以找到最優參數

**根本原因**:
- 參數搜索範圍過寬
- 市場環境不適合該策略
- 股票流動性不足

**解決方案**:
1. 縮小參數搜索範圍 (±20% 而非 ±50%)
2. 嘗試不同時間段或股票
3. 考慮使用更保守的策略

---

## 根本原因分析

### 數據不足 (最常見原因)

**檢測方法**:
```python
if roi == -999.0 and total_trades == 0:
    print("診斷: 數據不足")
    # 驗證:
    # 1. K線數 < 100
    # 2. 沒有進場信號
    # 3. 時間段 < 2 個月
```

**預防措施**:
- 最小時間段要求: **6 個月**
- 最小 K 線要求: **120 根**
- 交易次數要求: **> 5 筆**

### 參數衝突

**常見衝突場景**:

| 策略 | 衝突情況 | 修正 |
|------|---------|------|
| MA交叉 | fast_period ≥ slow_period | fast < slow 且差距 ≥ 5 |
| RSI反轉 | upper ≤ lower | upper > lower 且差距 ≥ 10 |
| MACD | fast ≥ slow | fast < slow 且差距 ≥ 5 |
| 布林帶 | std ≤ 0 | std > 0 且 > 1 |

### 過度優化

**症狀**:
- 訓練集表現優秀
- 測試集表現差
- 參數非常具體

**解決方案**:
- 使用交叉驗證
- 增加測試集時間範圍
- 簡化模型 (減少參數)

---

## 案例研究

### 案例 1: 時間段太短導致失敗

```
輸入:
  - 策略: MA交叉
  - 股票: 2330.TW
  - 時間段: 2025-11-01 至 2025-11-30 (1 個月)
  - 參數: fast=5-15, slow=20-50

輸出 (異常):
  - ROI: -999.00%
  - 勝率: 0.0%
  - Sharpe: 0.0
  - 交易: 0 筆

診斷:
  🔴 嚴重異常: 數據不足
  問題: 時間段只有 ~20 個交易日，無法產生足夠信號
  
建議:
  1. 選擇更長時間段 (至少 6 個月)
  2. 建議: 2025-08-01 至 2026-01-31
  3. 預期 K 線: ~120 根
  4. 預期成功率: 50-80%
  
實際修正後:
  - ROI: 0.35%
  - 勝率: 45%
  - Sharpe: 0.82
  - 交易: 85 筆
  ✅ 結論: 結果現在符合正常範圍
```

### 案例 2: 高 ROI 但樣本不足

```
輸入:
  - 策略: RSI反轉
  - 股票: 2301.TW
  - 時間段: 2025-11-15 至 2025-12-15 (1 個月)

輸出 (可疑):
  - ROI: 120.00% ⚠️ 過高
  - 勝率: 25.0%  ⚠️ 過低
  - Sharpe: 1.5
  - 交易: 8 筆  ⚠️ 過少

診斷:
  🟡 需要改進: 可能過度優化
  問題: 交易次數 < 30，樣本量不足
  高 ROI 可能來自幸運交易
  
建議:
  1. 在至少 6 個月時間段內重新測試
  2. 確保交易數 > 50 筆
  3. 在其他股票驗證策略
  4. 考慮使用交叉驗證
  
驗證結果:
  時間段擴大至 6 個月:
  - ROI: 5.2% ✓ 更現實
  - 勝率: 45%
  - 交易: 62 筆 ✓ 樣本充分
  ✅ 結論: 之前結果為過度優化
```

### 案例 3: 參數邏輯錯誤

```
輸入:
  - 策略: MA交叉
  - 參數: fast=30, slow=15 ❌ 錯誤!
  
輸出:
  - ROI: -999%
  - 交易: 0 筆 (信號衝突)

診斷:
  🔴 嚴重異常: 參數邏輯錯誤
  問題: fast_period (30) > slow_period (15)
  MA交叉需要 fast < slow
  
修正:
  - 改為: fast=5, slow=20 ✓
  
修正後結果:
  - ROI: 2.15%
  - 勝率: 52%
  - 交易: 76 筆
  ✅ 結論: 參數修正解決問題
```

---

## 最佳實踐

### 診斷檢查清單

- [ ] **第 1 步**: 檢查數據充分性
  - [ ] 時間段 ≥ 6 個月?
  - [ ] K 線數 > 100?
  - [ ] 交易次數 > 5?

- [ ] **第 2 步**: 驗證參數邏輯
  - [ ] fast < slow (MA交叉)?
  - [ ] upper > lower (RSI)?
  - [ ] 參數在合理範圍內?

- [ ] **第 3 步**: 評估結果品質
  - [ ] ROI 在 -50% 至 +100% 範圍?
  - [ ] 勝率 > 30%?
  - [ ] Sharpe > 0.5?
  - [ ] 成功率 > 80%?

- [ ] **第 4 步**: 判斷優化程度
  - [ ] 交易次數 > 30?
  - [ ] 在不同時間段一致?
  - [ ] 在不同股票驗證?

### 推薦的參數預設

#### 保守配置 (低風險)
```json
{
  "time_period": "12 months",
  "min_k_lines": 200,
  "min_trades": 50,
  "param_range": "±10%",
  "target_roi": "5-15%",
  "target_win_rate": "45-55%",
  "target_sharpe": "0.8-2.0"
}
```

#### 平衡配置 (中等風險)
```json
{
  "time_period": "6 months",
  "min_k_lines": 120,
  "min_trades": 30,
  "param_range": "±20%",
  "target_roi": "10-30%",
  "target_win_rate": "40-60%",
  "target_sharpe": "0.5-1.5"
}
```

#### 積極配置 (高風險)
```json
{
  "time_period": "3 months",
  "min_k_lines": 60,
  "min_trades": 10,
  "param_range": "±50%",
  "target_roi": "20-100%+",
  "target_win_rate": "30-70%",
  "target_sharpe": "0.2-2.0"
}
```

### 常見問題 (FAQ)

**Q1: ROI -999% 一定意味著數據不足嗎?**

A: 不一定。檢查清單:
1. 交易數 = 0? → 99% 數據不足
2. 交易數 > 0? → 檢查參數衝突或策略邏輯

**Q2: 何時認為結果過度優化?**

A: 滿足以下條件時:
- 交易次數 < 30 筆
- 時間段 < 3 個月
- 在其他股票無法複製

**Q3: 應該接受哪個 ROI 範圍?**

A: 根據風險容度:
- 保守: 5% - 20%
- 中等: 10% - 50%
- 積極: 20% - 100%+

**Q4: 低勝率但高 ROI 是好結果嗎?**

A: 需要驗證:
1. 交易次數 > 50? → 可能可信
2. 交易次數 < 30? → 可能過度優化
3. 單筆贏利是否過大? → 檢查風險管理

**Q5: 什麼時候應該放棄一個參數組合?**

A: 以下情況建議放棄:
- ROI < -30% 且勝率 < 30%
- 成功率 < 20% (< 5/25 組合成功)
- 在至少 3 個不同股票失敗
- Sharpe < 0.1

---

## 附錄

### 附錄 A: 診斷函數實現

```python
def diagnose_training_result(results: dict) -> tuple:
    """
    診斷訓練結果
    返回: (status, issues_list, recommendations_list)
    """
    issues = []
    recommendations = []
    status = "✅ 正常"
    
    roi = results.get('best_roi', 0)
    win_rate = results.get('best_win_rate', 0)
    sharpe = results.get('best_sharpe', 0)
    total_trades = results.get('total_trades', 0)
    
    # 檢查 ROI
    if roi == -999.0:
        issues.append("❌ ROI -999% (所有參數組合失敗)")
        status = "❌ 嚴重異常"
        if total_trades == 0:
            recommendations.append("✓ 原因: 數據不足")
            recommendations.append("✓ 解決: 選擇更長時間段 (≥ 6 個月)")
    
    # 檢查勝率
    if win_rate == 0.0 and total_trades == 0:
        issues.append("❌ 無交易信號")
        if status != "❌ 嚴重異常":
            status = "❌ 嚴重異常"
    
    return (status, issues, recommendations)
```

### 附錄 B: 推薦工具

- **Excel/Google Sheets**: 診斷矩陣追蹤
- **Jupyter Notebook**: 根本原因深度分析
- **Discord Bot 診斷命令**: `!train-check <task_id>`

---

**最後更新**: 2026-02-01  
**維護者**: Stock Quant V12.0 Team  
**支持**: 聯繫管理員或查看 [訓練佇列文檔](../utils/training_queue.py)
